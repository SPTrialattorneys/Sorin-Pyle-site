#!/usr/bin/env node

/**
 * Pre-Commit Validation Check
 *
 * Runs before git commit to prevent common mistakes:
 * 1. Prevent committing dist/ files
 * 2. Check for console.log in production JS
 * 3. Check for TODO comments in .njk templates
 * 4. Validate schema markup
 * 5. Validate HTML (broken links, missing alt text, duplicate IDs)
 *
 * Usage: npm run pre-commit-check
 * Or: Automatically runs via husky pre-commit hook
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// ANSI color codes
const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  gray: '\x1b[90m'
};

let hasErrors = false;
let hasWarnings = false;

console.log(`${colors.blue}ðŸ” Pre-Commit Validation${colors.reset}\n`);

/**
 * Check 1: Prevent committing dist/ files
 */
function checkDistFiles() {
  console.log(`${colors.blue}1. Checking for dist/ files...${colors.reset}`);

  try {
    const stagedFiles = execSync('git diff --cached --name-only', { encoding: 'utf8' });
    const distFiles = stagedFiles.split('\n').filter(file => file.startsWith('dist/'));

    if (distFiles.length > 0) {
      console.log(`${colors.red}âœ— Found ${distFiles.length} dist/ files staged for commit:${colors.reset}`);
      distFiles.forEach(file => {
        console.log(`  ${colors.red}â€¢${colors.reset} ${file}`);
      });
      console.log(`\n${colors.yellow}Fix: Unstage dist/ files with:${colors.reset}`);
      console.log(`  git reset HEAD dist/`);
      console.log(`\n${colors.gray}Reminder: Never commit dist/ - it's auto-generated by build${colors.reset}`);
      hasErrors = true;
      return false;
    }

    console.log(`${colors.green}âœ“ No dist/ files staged${colors.reset}\n`);
    return true;
  } catch (error) {
    console.log(`${colors.yellow}âš  Could not check staged files (not a git repo?)${colors.reset}\n`);
    return true;
  }
}

/**
 * Check 2: Check for console.log in production JS
 */
function checkConsoleLogs() {
  console.log(`${colors.blue}2. Checking for console.log in production JS...${colors.reset}`);

  try {
    const stagedFiles = execSync('git diff --cached --name-only', { encoding: 'utf8' });
    const jsFiles = stagedFiles.split('\n').filter(file =>
      (file.endsWith('.js') || file.endsWith('.mjs')) &&
      file.startsWith('src/') &&
      file !== 'src/assets/scripts/analytics.js' // Allow console.log in analytics
    );

    let foundConsoleLogs = [];

    for (const file of jsFiles) {
      if (!file || !fs.existsSync(file)) continue;

      const content = fs.readFileSync(file, 'utf8');
      const lines = content.split('\n');

      lines.forEach((line, index) => {
        if (line.match(/console\.log\(/)) {
          foundConsoleLogs.push({
            file,
            line: index + 1,
            content: line.trim()
          });
        }
      });
    }

    if (foundConsoleLogs.length > 0) {
      console.log(`${colors.yellow}âš  Found ${foundConsoleLogs.length} console.log statement(s):${colors.reset}`);
      foundConsoleLogs.forEach(item => {
        console.log(`  ${colors.yellow}â€¢${colors.reset} ${item.file}:${item.line}`);
        console.log(`    ${colors.gray}${item.content}${colors.reset}`);
      });
      console.log(`\n${colors.yellow}Warning: Remove console.log before committing production JS${colors.reset}`);
      hasWarnings = true;
      return true; // Warning, not error
    }

    console.log(`${colors.green}âœ“ No console.log found in production JS${colors.reset}\n`);
    return true;
  } catch (error) {
    console.log(`${colors.gray}â—‹ Skipped (no staged JS files)${colors.reset}\n`);
    return true;
  }
}

/**
 * Check 3: Check for TODO comments in .njk templates
 */
function checkTodoComments() {
  console.log(`${colors.blue}3. Checking for TODO comments in templates...${colors.reset}`);

  try {
    const stagedFiles = execSync('git diff --cached --name-only', { encoding: 'utf8' });
    const njkFiles = stagedFiles.split('\n').filter(file => file.endsWith('.njk'));

    let foundTodos = [];

    for (const file of njkFiles) {
      if (!file || !fs.existsSync(file)) continue;

      const content = fs.readFileSync(file, 'utf8');
      const lines = content.split('\n');

      lines.forEach((line, index) => {
        // Look for TODO in HTML comments or Nunjucks comments
        if (line.match(/<!--.*TODO/i) || line.match(/\{#.*TODO/i)) {
          foundTodos.push({
            file,
            line: index + 1,
            content: line.trim()
          });
        }
      });
    }

    if (foundTodos.length > 0) {
      console.log(`${colors.yellow}âš  Found ${foundTodos.length} TODO comment(s):${colors.reset}`);
      foundTodos.forEach(item => {
        console.log(`  ${colors.yellow}â€¢${colors.reset} ${item.file}:${item.line}`);
        console.log(`    ${colors.gray}${item.content.substring(0, 80)}${colors.reset}`);
      });
      console.log(`\n${colors.yellow}Warning: Consider resolving TODOs before committing${colors.reset}`);
      hasWarnings = true;
      return true; // Warning, not error
    }

    console.log(`${colors.green}âœ“ No TODO comments found${colors.reset}\n`);
    return true;
  } catch (error) {
    console.log(`${colors.gray}â—‹ Skipped (no staged .njk files)${colors.reset}\n`);
    return true;
  }
}

/**
 * Check 4: Validate schema markup
 */
function validateSchema() {
  console.log(`${colors.blue}4. Validating schema markup...${colors.reset}`);

  // Check if dist/ directory exists
  const distDir = path.join(__dirname, '..', 'dist');
  if (!fs.existsSync(distDir)) {
    console.log(`${colors.gray}â—‹ Skipped (dist/ not found - run build first)${colors.reset}\n`);
    return true;
  }

  // Check if any schema-related files are staged
  try {
    const stagedFiles = execSync('git diff --cached --name-only', { encoding: 'utf8' });
    const hasSchemaFiles = stagedFiles.split('\n').some(file =>
      file.endsWith('.njk') || file.startsWith('src/')
    );

    if (!hasSchemaFiles) {
      console.log(`${colors.gray}â—‹ Skipped (no template files staged)${colors.reset}\n`);
      return true;
    }
  } catch (error) {
    // Continue with validation if can't check staged files
  }

  // Run schema validation
  try {
    execSync('node utilities/validate-schema.js', {
      stdio: 'inherit',
      encoding: 'utf8'
    });
    console.log(); // Add blank line after validation output
    return true;
  } catch (error) {
    // Schema validation failed - error already printed by validate-schema.js
    hasErrors = true;
    return false;
  }
}

/**
 * Check 5: Validate HTML
 */
function validateHtml() {
  console.log(`${colors.blue}5. Validating HTML...${colors.reset}`);

  // Check if dist/ directory exists
  const distDir = path.join(__dirname, '..', 'dist');
  if (!fs.existsSync(distDir)) {
    console.log(`${colors.gray}â—‹ Skipped (dist/ not found - run build first)${colors.reset}\n`);
    return true;
  }

  // Check if any HTML-related files are staged
  try {
    const stagedFiles = execSync('git diff --cached --name-only', { encoding: 'utf8' });
    const hasHtmlFiles = stagedFiles.split('\n').some(file =>
      file.endsWith('.njk') || file.endsWith('.html') || file.startsWith('src/')
    );

    if (!hasHtmlFiles) {
      console.log(`${colors.gray}â—‹ Skipped (no template/HTML files staged)${colors.reset}\n`);
      return true;
    }
  } catch (error) {
    // Continue with validation if can't check staged files
  }

  // Run HTML validation
  try {
    execSync('node utilities/validate-html.js', {
      stdio: 'inherit',
      encoding: 'utf8'
    });
    console.log(); // Add blank line after validation output
    return true;
  } catch (error) {
    // HTML validation failed - error already printed by validate-html.js
    hasErrors = true;
    return false;
  }
}

/**
 * Main function
 */
function main() {
  const check1 = checkDistFiles();
  const check2 = checkConsoleLogs();
  const check3 = checkTodoComments();
  const check4 = validateSchema();
  const check5 = validateHtml();

  // Summary
  console.log('â”€'.repeat(60));

  if (hasErrors) {
    console.log(`${colors.red}âœ— Pre-commit validation FAILED${colors.reset}`);
    console.log(`\n${colors.gray}Fix errors above before committing.${colors.reset}`);
    console.log(`${colors.gray}To skip validation (not recommended): git commit --no-verify${colors.reset}`);
    process.exit(1);
  } else if (hasWarnings) {
    console.log(`${colors.yellow}âš  Pre-commit validation passed with warnings${colors.reset}`);
    console.log(`\n${colors.gray}Review warnings above. Proceeding with commit...${colors.reset}`);
    process.exit(0);
  } else {
    console.log(`${colors.green}âœ“ All pre-commit checks passed!${colors.reset}`);
    process.exit(0);
  }
}

// Run checks
main();
